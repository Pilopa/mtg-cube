import { Directive, HostBinding, OnInit, OnDestroy, Input } from '@angular/core';
import { SafeStyle, DomSanitizer } from '@angular/platform-browser';
import { Store, Select } from '@ngxs/store';
import { Subject, Observable, combineLatest } from 'rxjs';
import { takeUntil, map, switchMap, switchMapTo } from 'rxjs/operators';
import { LoadImage } from '../state/card-image/card-image.state.actions';
import { CardImageState, GetImageFn } from '../state/card-image/card-image.state';
import { LayoutState } from '../state/layout/layout.state';
import { LayoutSize } from '../models/layout-size.model';
import { CardImageSize } from '../models/card-image.model';
import { layoutSize2CardImageSize } from '../utils/card-image-utils';

@Directive({
  selector: '[appCardImage]'
})
export class CardImageDirective implements OnInit, OnDestroy {

  // tslint:disable-next-line:max-line-length
  public static CARD_BACK = 'data:image/jpeg;base64,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';

  @Input('appCardImage')
  set multiverseId(newMultiverseId: number) {
    this._multiverseId$.next(newMultiverseId);
  }

  @Input()
  set cardImageSize(newCardImageSize: CardImageSize | undefined) {
    this._cardImageSize$.next(newCardImageSize);
  }

  @HostBinding('style.background')
  cardBackground: SafeStyle;

  @Select(CardImageState.getCardImageFn)
  cardImageFn$: Observable<GetImageFn>;

  @Select(LayoutState.getLayoutSize)
  layoutSize$: Observable<LayoutSize>;

  private readonly _destroy$ = new Subject<void>();
  private readonly _multiverseId$ = new Subject<number>();
  private readonly _cardImageSize$ = new Subject<CardImageSize | undefined>();

  constructor(private readonly sanitizer: DomSanitizer, private readonly store: Store) { }

  private createBackgroundStyle(imageUrl: string) {
    return this.sanitizer.bypassSecurityTrustStyle(`url(${imageUrl}) no-repeat center cover`);
  }

  ngOnInit(): void {
    combineLatest(this._multiverseId$, combineLatest(this.layoutSize$, this._cardImageSize$).pipe(
      map(([layoutSize, cardImageSize]) => cardImageSize || layoutSize2CardImageSize(layoutSize))
    )).pipe(
      switchMap(([multiverseId, cardImageSize]) => this.store.dispatch(new LoadImage(multiverseId, cardImageSize)).pipe(
        switchMapTo(this.cardImageFn$),
        map(cardImageFn => this.createBackgroundStyle(cardImageFn(multiverseId, cardImageSize) || CardImageDirective.CARD_BACK))
      )),
      takeUntil(this._destroy$)
    ).subscribe(backgroundStyle => this.cardBackground = backgroundStyle);
  }

  ngOnDestroy(): void {
    this._destroy$.next();
  }

}
